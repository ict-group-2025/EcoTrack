import requests
import json
import time
from datetime import datetime

# === C·∫§U H√åNH ===
API_KEY = "51fd68be8c2e7e6b965291693ec85e04"        # üîë Thay b·∫±ng API key c·ªßa b·∫°n
CITY = "Hanoi,vn"               # Th√†nh ph·ªë mu·ªën l·∫•y d·ªØ li·ªáu
INTERVAL = 1800                 # Th·ªùi gian c·∫≠p nh·∫≠t (gi√¢y): 1800s = 30 ph√∫t
OUTPUT_FILE = "weather.json"    # File l∆∞u d·ªØ li·ªáu

# === V√íNG L·∫∂P L·∫§Y D·ªÆ LI·ªÜU ===
while True:
    try:
        # 1Ô∏è‚É£ G·ª≠i request t·ªõi API OpenWeather
        url = f"https://api.openweathermap.org/data/2.5/weather?q={CITY}&appid={API_KEY}"
        response = requests.get(url)
        data = response.json()

        # 2Ô∏è‚É£ Th√™m th·ªùi gian ghi nh·∫≠n
        data["local_time"] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

        # 3Ô∏è‚É£ Ghi v√†o file JSON
        with open(OUTPUT_FILE, "a", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False)
            f.write("\n")  # xu·ªëng d√≤ng ƒë·ªÉ l∆∞u nhi·ªÅu b·∫£n ghi

        # 4Ô∏è‚É£ In ra console ƒë·ªÉ ki·ªÉm tra
        temp_c = round(data["main"]["temp"] - 273.15, 1)
        print(f"[{data['local_time']}] {data['name']}: {temp_c}¬∞C, {data['weather'][0]['description']}")

        # 5Ô∏è‚É£ ƒê·ª£i tr∆∞·ªõc khi c·∫≠p nh·∫≠t l·∫ßn sau
        time.sleep(INTERVAL)

    except Exception as e:
        print("‚ö†Ô∏è L·ªói:", e)
        time.sleep(30)  # ch·ªù 30s r·ªìi th·ª≠ l·∫°i
