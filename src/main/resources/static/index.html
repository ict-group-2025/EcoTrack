<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weather & Chat Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        .chat-box { height: 400px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; }
        .message { margin-bottom: 10px; padding: 5px; border-radius: 5px; }
        .my-msg { background-color: #d1e7dd; text-align: right; }
        .other-msg { background-color: #f8d7da; }
    </style>
</head>
<body class="bg-light">

<div class="container mt-4">
    <div class="row">
        <div class="col-md-5">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">Tra cứu Thời tiết</div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="text" id="cityInput" class="form-control" placeholder="Nhập tên thành phố (vd: Hanoi)">
                        <button class="btn btn-dark" onclick="searchCity()">Tra cứu</button>
                    </div>

                    <div id="weatherResult" class="d-none">
                        <h3 id="cityName">--</h3>
                        <p>Quốc gia: <span id="country">--</span></p>
                        <div class="row text-center">
                            <div class="col-6">
                                <h1><span id="temp">--</span>°C</h1>
                                <p id="desc">--</p>
                            </div>
                            <div class="col-6">
                                <img id="icon" src="" style="width: 80px;">
                            </div>
                        </div>
                        <hr>
                        <p>Độ ẩm: <span id="humidity">--</span>%</p>
                        <p>Gió: <span id="wind">--</span> m/s</p>
                        <p>Ô nhiễm (CO): <span id="co">--</span></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    Thảo luận: <span id="chatRoomName">Chưa chọn thành phố</span>
                </div>
                <div class="card-body">
                    <div id="chatArea" class="chat-box mb-3">
                        <div class="text-center text-muted">Hãy tìm kiếm thành phố để tham gia chat!</div>
                    </div>
                    <div class="input-group">
                        <input type="text" id="username" class="form-control" placeholder="Tên bạn..." style="max-width: 150px;">
                        <input type="text" id="message" class="form-control" placeholder="Nhập tin nhắn..." disabled>
                        <button id="sendBtn" class="btn btn-success" onclick="sendMessage()" disabled>Gửi</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let stompClient = null;
    let currentLocationId = null;

    // 1. HÀM TRA CỨU THỜI TIẾT
    function searchCity() {
        let city = $("#cityInput").val();
        if(!city) return alert("Vui lòng nhập tên thành phố!");

        $.get("http://localhost:8080/api/weather/search?city=" + city, function(data) {
            // Hiển thị dữ liệu thời tiết
            $("#weatherResult").removeClass("d-none");
            $("#cityName").text(data.cityName);
            $("#country").text(data.country);
            $("#temp").text(data.temperature);
            $("#desc").text(data.weatherDescription);
            $("#humidity").text(data.humidity);
            $("#wind").text(data.windSpeed);
            $("#co").text(data.co);
            $("#icon").attr("src", "http://openweathermap.org/img/wn/" + data.weatherIcon + "@2x.png");

            // KÍCH HOẠT CHAT CHO THÀNH PHỐ NÀY
            connectChat(data.locationId, data.cityName);
        }).fail(function() {
            alert("Không tìm thấy thành phố hoặc lỗi Server!");
        });
    }

    // 2. KẾT NỐI WEBSOCKET
    function connectChat(locationId, cityName) {
        if (currentLocationId === locationId) return; // Đang ở đúng phòng rồi thì thôi
        currentLocationId = locationId;

        // Ngắt kết nối cũ nếu có
        if (stompClient !== null) stompClient.disconnect();

        // Cập nhật giao diện
        $("#chatRoomName").text(cityName);
        $("#chatArea").html('<div class="text-center text-success">Đang kết nối vào phòng ' + cityName + '...</div>');
        $("#message").prop("disabled", false);
        $("#sendBtn").prop("disabled", false);

        // Kết nối mới
        let socket = new SockJS('/chat-websocket');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // Xóa thông báo đang kết nối
            $("#chatArea").html('');

            // A. Tải lịch sử chat cũ
            loadHistory(locationId);

            // B. Đăng ký nhận tin nhắn mới Realtime
            stompClient.subscribe('/topic/' + locationId, function (messageOutput) {
                showMessage(JSON.parse(messageOutput.body));
            });
        });
    }

    // 3. TẢI LỊCH SỬ TIN NHẮN
    function loadHistory(locationId) {
        $.get("http://localhost:8080/api/chat/history/" + locationId, function(messages) {
            messages.forEach(msg => showMessage(msg));
        });
    }

    // 4. GỬI TIN NHẮN
    function sendMessage() {
        let text = $("#message").val();
        let user = $("#username").val() || "Ẩn danh"; // Nếu chưa nhập tên thì là Ẩn danh

        if(text && stompClient) {
            stompClient.send("/app/chat/" + currentLocationId + "/sendMessage", {},
                JSON.stringify({'sender': user, 'content': text, 'type': 'CHAT'})
            );
            $("#message").val(""); // Xóa ô nhập
        } else {
            alert("Vui lòng nhập tên và tin nhắn!");
        }
    }

    // 5. HIỂN THỊ TIN NHẮN LÊN MÀN HÌNH
    function showMessage(msg) {
        let currentUser = $("#username").val() || "Ẩn danh";
        let isMe = msg.sender === currentUser;
        let html = `
            <div class="message ${isMe ? 'my-msg' : 'other-msg'}">
                <strong>${msg.sender}:</strong> ${msg.content}
            </div>
        `;
        $("#chatArea").append(html);
        // Tự cuộn xuống dưới cùng
        $("#chatArea").scrollTop($("#chatArea")[0].scrollHeight);
    }
</script>

</body>
</html>